#!/bin/bash
SYS_URL='http://localhost:8080'

APP_YAML=app.yaml
FRONTEND_YAML=frontend/frontend.yaml
BACKEND_YAML=backend/backend.yaml
WORKER_YAML=backend/worker.yaml

DOMAIN="eciis-splab.appspot.com"

BACKEND_DOMAIN="backend.$DOMAIN"

BACKEND_LOCAL="localhost:8082"

LANDINGPAGE_LOCAL="localhost:8080"

FRONTEND_CONFIG_FILE="frontend/config.js"

PY_ENV=backend/py_env

bold=$(tput bold)
_bold=$(tput sgr0)

function set_backend_url {
    if [ -z $1 ]; then
        url="http://$BACKEND_DOMAIN"
    else
        url="http://"$1
    fi
    sed -i "4s|.*|    BACKEND_URL: '$url',|" $FRONTEND_CONFIG_FILE
    echo ">> Frontend will use ${bold}$url${_bold} as backend."
}

function set_landingpage_url {
    if [ -z $1 ]; then
        url="http://$DOMAIN"
    else
        url="http://"$1
    fi
    sed -i "5s|.*|    LANDINGPAGE_URL: '$url'|" $FRONTEND_CONFIG_FILE
    echo ">> Frontend will use ${bold}$url${_bold} as landing page."
}

case "$1" in
    run)
        echo "=========== Cleaning Environment ==========="
        rm -rf $PY_ENV
        rm -rf frontend/test/node_modules frontend/test/bower_components

        echo "=========== Starting Virtual Environment ==========="
        virtualenv $PY_ENV
        source $PY_ENV/bin/activate

        echo "=========== Installing Dependencies ==========="
        python -m pip install -r backend/requirements.txt

        touch .env_cleaned # Flag to the test script knows that the env was cleaned

        if which xdg-open > /dev/null
        then
          xdg-open $SYS_URL
        elif which gnome-open > /dev/null
        then
          gnome-open $SYS_URL
        fi

        echo "=========== Starting Microservices ==========="

        set_backend_url $BACKEND_LOCAL

        set_landingpage_url $LANDINGPAGE_LOCAL

        dev_appserver.py $APP_YAML $FRONTEND_YAML $BACKEND_YAML $WORKER_YAML $2
    ;;

    test)
        case "$2" in
            client)
                echo "=========== Starting Fronted Tests ==========="
                cd frontend/test
                
                if [ ! -e node_modules ]; then
                    npm install
                fi

                if [ ! -e bower_components ]; then
                    bower install
                fi

                karma start --single-run
            ;;

            server)
                if [ "$3" == "--clean" ]; then
                    ./setup_env_test clean
                else
                    ./setup_env_test
                fi

                if [ $? != 0 ]; then # Verify the last script output looking for an error
                    exit 1 # Stop the script execution
                fi
                echo "=========== Starting Backend Tests ==========="
                source $PY_ENV/bin/activate
                cd backend
                python -m unittest discover -v -p "*test.py"
        esac
    ;;

    deploy)
        echo "=========== Staring Google App Engine Deployment ==========="

        if [ ! -z $2 ]; then
            version=$2
            url=$version"."$BACKEND_DOMAIN
            set_backend_url $url

            url=$version"."$DOMAIN
            set_landingpage_url $url

            if [ ! -z $3 ]; then # Especified one or more yaml configuration files
                gcloud app deploy --version $version --no-promote $3
            else
                gcloud app deploy --version $version --no-promote $APP_YAML $FRONTEND_YAML $BACKEND_YAML $WORKER_YAML queue.yaml
            fi
        else
            set_backend_url
            set_landingpage_url
            gcloud app deploy $APP_YAML $FRONTEND_YAML $BACKEND_YAML $WORKER_YAML
        fi

        exit 0
        ;;

    *)
        echo "$1 is not a ecis command."
        echo "Usage: $0 {run|test|deploy}"
        exit 1
esac
